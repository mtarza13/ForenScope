{% extends "base.html" %}

{% block title %}Case Details - EviForge{% endblock %}

{% block content %}
<div class="layout-grid" style="min-height:auto; display:block;">
    <div class="flex between mb-4">
        <div>
            <div class="text-sm text-muted"> <a href="/web">Dashboard</a> / Case</div>
            <h2 class="mt-1" id="caseTitleDisplay">Loading...</h2>
        </div>
        <div class="flex">
            <span class="badge badge-info" id="caseIdBadge">{{ case_id }}</span>
        </div>
    </div>

    <!-- Tabs Layout -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('evidence')">Evidence Vault</div>
        <div class="tab-btn" onclick="switchTab('jobs')">Jobs & Modules</div>
        <div class="tab-btn" onclick="switchTab('artifacts')">Artifacts</div>
        <div class="tab-btn" onclick="switchTab('iocs')">IOCs & Findings</div>
    </div>

    <!-- EVIDENCE TAB -->
    <div id="evidence" class="tab-content active">
        <div class="card">
            <div class="flex between mb-4">
                <h3>Evidence Items</h3>
                <div class="flex" style="flex-wrap: wrap; justify-content: flex-end;">
                    <div class="flex" style="gap:0.5rem;">
                        <input type="text" id="importFilename" placeholder="File in /import (e.g. disk.img)">
                        <button onclick="ingestEvidence()" class="btn btn-primary">Ingest</button>
                    </div>
                    <form id="uploadForm" class="flex" style="gap:0.5rem;" onsubmit="uploadEvidence(event)">
                        <input type="file" id="uploadFile" required>
                        <button type="submit" class="btn btn-outline">Upload</button>
                    </form>
                </div>
            </div>

            <table id="evidenceTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Ingested</th>
                        <th>Integrity (SHA256)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="text-muted text-center">Loading evidence...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- JOBS TAB -->
    <div id="jobs" class="tab-content">
        <div class="card">
            <div class="flex between mb-4">
                <h3>Forensic Modules</h3>
                <div class="flex">
                    <select id="moduleSelect">
                        <option value="" disabled selected>Select Module...</option>
                        <option value="inventory">Inventory (List Files)</option>
                        <option value="strings">Strings Extraction</option>
                        <option value="timeline">Timeline (MACE)</option>
                        <option value="parse_text">Parse Text (Tika)</option>
                        <option value="exif">Exif Metadata</option>
                        <option value="triage">Triage (Entropy/Type)</option>
                        <option value="verify">Verify (Re-hash)</option>
                        <option value="report">Report (Case HTML)</option>
                        <option value="pcap">PCAP (tshark)</option>
                        <option value="browser">Browser SQLite</option>
                        <option value="email">Email (EML/MBOX)</option>
                        <option value="evtx">EVTX (Windows Logs)</option>
                        <option value="registry">Registry (Hives)</option>
                        <option value="yara">YARA Scan</option>
                        <option value="bulk">Bulk Extractor</option>
                        <option value="carve">Carve (foremost)</option>
                    </select>
                    <select id="targetEvidenceId" title="Evidence item">
                        <option value="" selected>No evidence loaded</option>
                    </select>
                    <input type="text" id="jobParams" placeholder='Params JSON (optional)' style="min-width:220px;">
                    <button onclick="runJob()" class="btn btn-primary">Run Module</button>
                </div>
            </div>

            <table id="jobsTable">
                <thead>
                    <tr>
                        <th>Module</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Results / Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4" class="text-muted text-center">Loading jobs...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ARTIFACTS TAB -->
    <div id="artifacts" class="tab-content">
        <div class="card">
            <div class="flex between mb-4">
                <div>
                    <h3>Artifacts Browser</h3>
                    <div class="text-muted text-sm">Browse module outputs under the case vault (read-only).</div>
                </div>
                <div class="flex" style="gap:0.5rem;">
                    <button class="btn btn-sm btn-outline" type="button" onclick="artifactsUp()">Up</button>
                    <span class="badge badge-info text-mono" id="artifactsPath">/</span>
                </div>
            </div>

            <div class="artifact-browser">
                <div class="artifact-tree">
                    <div class="text-muted text-sm mb-2">Folders / Files</div>
                    <div id="artifactTree" class="artifact-list">Loading…</div>
                </div>
                <div class="artifact-preview">
                    <div class="text-muted text-sm mb-2">Preview</div>
                    <div id="artifactPreview" class="pre-block">Select a file to preview.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- IOCS TAB -->
    <div id="iocs" class="tab-content">
        <div class="layout-grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; display:grid;">
            <!-- Findings (Left) -->
            <div class="card">
                <h3>System Findings</h3>
                <div id="findingsList" style="display:flex; flex-direction:column; gap:0.5rem;">
                    <div class="text-muted text-center p-4">Loading matches...</div>
                </div>
            </div>

            <!-- IOC Management (Right) -->
            <div class="card">
                <div class="flex between mb-4">
                    <h3>IOC Watchlist</h3>
                </div>
                <div class="flex mb-4">
                    <select id="iocType" style="width:100px;">
                        <option value="ip">IP</option>
                        <option value="domain">Domain</option>
                        <option value="md5">MD5</option>
                    </select>
                    <input type="text" id="iocValue" placeholder="Value (e.g. 1.2.3.4)" style="flex-grow:1;">
                    <button onclick="addIOC()" class="btn btn-outline">Add</button>
                </div>

                <table id="iocListTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Con.</th>
                            <th>Added</th>
                        </tr>
                    </thead>
                    <tbody id="iocList">
                        <tr>
                            <td colspan="4" class="text-muted text-center">No IOCs.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>



</div>
{% endblock %}

{% block scripts %}
<script>
    const CASE_ID = "{{ case_id }}";
    let EVIDENCE_ITEMS = [];
    let CURRENT_ARTIFACTS_PATH = "";
    const MODULE_REQUIRES_EVIDENCE = new Set([
        "inventory", "strings", "timeline", "parse_text", "exif", "triage", "verify",
        "pcap", "browser", "email", "evtx", "registry", "yara", "bulk", "carve",
    ]);

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[c]));
    }

    // Tab Logic
    function switchTab(tabId) {
        // Toggle Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('onclick').includes(tabId));
        });
        // Toggle Content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === tabId) content.classList.add('active');
        });

        // Lazy Load
        if (tabId === 'evidence') loadEvidence();
        if (tabId === 'jobs') loadJobs();
        if (tabId === 'artifacts') loadArtifacts();
        if (tabId === 'iocs') { loadIOCs(); loadMatches(); }
    }

    // --- DATA LOADING ---
    async function loadData() {
        try {
            const caseRes = await apiFetch(`/api/cases/${CASE_ID}`);
            if (caseRes.ok) {
                const c = await caseRes.json();
                document.getElementById('caseTitleDisplay').innerText = c.name;
                // document.title = `Case ${c.name} - EviForge`;
            }
            loadEvidence();
            loadJobs();
        } catch (e) { console.error(e); }
    }

    // --- EVIDENCE ---
    async function loadEvidence() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence`);
        const tbody = document.querySelector('#evidenceTable tbody');
        if (!res.ok) return;

        const items = await res.json();
        EVIDENCE_ITEMS = items;
        refreshEvidenceSelect(items);
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No evidence ingested yet.</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(ev => `
            <tr>
                <td class="text-mono text-sm text-muted">${ev.id.substring(0, 8)}</td>
                <td style="font-weight:500;">${escapeHtml(ev.filename)}</td>
                <td class="text-sm">${(ev.size / 1024).toFixed(2)} KB</td>
                <td class="text-sm text-muted">${new Date(ev.ingested_at).toLocaleString()}</td>
                <td class="text-mono text-xs">
                    ${ev.hashes.sha256 ? ev.hashes.sha256.substring(0, 16) + "..." : '<span class="badge badge-warning">Pending</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline" type="button" onclick="copyText('${ev.id}')">Copy ID</button>
                </td>
            </tr>
        `).join('');
    }

    async function ingestEvidence() {
        const filename = document.getElementById('importFilename').value;
        if (!filename) return alert("Enter a filename");
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename })
        });
        if (res.ok) { document.getElementById('importFilename').value = ''; loadEvidence(); }
        else alert('Ingest failed');
    }

    async function uploadEvidence(e) {
        e.preventDefault();
        const fileInput = document.getElementById('uploadFile');
        if (!fileInput.files || !fileInput.files.length) return;
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence/upload`, { method: 'POST', body: fd });
        if (res.ok) { fileInput.value = ''; loadEvidence(); }
        else alert('Upload failed');
    }

    function refreshEvidenceSelect(items) {
        const sel = document.getElementById('targetEvidenceId');
        if (!sel) return;
        if (!items || items.length === 0) {
            sel.innerHTML = '<option value="" selected>No evidence loaded</option>';
            return;
        }
        sel.innerHTML = ['<option value="" selected>Select evidence…</option>'].concat(
            items.map(ev => `<option value="${ev.id}">${ev.filename} (${ev.id.substring(0, 8)})</option>`)
        ).join('');
    }

    // --- JOBS ---
    async function loadJobs() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/jobs`);
        const tbody = document.querySelector('#jobsTable tbody');
        if (!res.ok) return;

        const items = await res.json();
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No jobs run yet.</td></tr>';
            return;
        }

        function artifactUrl(p) {
            const parts = String(p).split('/').map(encodeURIComponent).join('/');
            return `/api/artifacts/${CASE_ID}/${parts}`;
        }

        tbody.innerHTML = items.map(job => {
            let statusBadge = `<span class="badge badge-info">${job.status}</span>`;
            if (job.status === 'COMPLETED') statusBadge = `<span class="badge badge-success">Completed</span>`;
            if (job.status === 'FAILED') statusBadge = `<span class="badge badge-danger">Failed</span>`;
            if (job.status === 'RUNNING') statusBadge = `<span class="badge badge-warning">Running</span>`;

            let actions = '<span class="text-muted text-sm">-</span>';
            if (job.output_files && job.output_files.length > 0) {
                actions = job.output_files.map(p =>
                    `<a href="${artifactUrl(p)}" target="_blank" class="text-sm">Download</a>`
                ).join('<br>');
            } else if (job.status === 'FAILED') {
                actions = `<span class="text-danger text-sm" title="${escapeHtml(job.error || 'Unknown Error')}">Failed</span>`;
            }

            actions = `<a class="text-sm" href="/web/jobs/${job.id}">View Job</a><br>` + actions;

            return `
                <tr>
                    <td style="font-weight:500;">${job.module}</td>
                    <td>${statusBadge}</td>
                    <td class="text-sm text-muted">${new Date(job.created_at).toLocaleString()}</td>
                    <td>${actions}</td>
                </tr>
            `;
        }).join('');
    }

    async function runJob() {
        const module = document.getElementById('moduleSelect').value;
        const evidenceId = document.getElementById('targetEvidenceId').value;
        const paramsRaw = (document.getElementById('jobParams')?.value || '').trim();
        if (!module) return alert('Select module');
        if (MODULE_REQUIRES_EVIDENCE.has(module) && !evidenceId) return alert('Select evidence (required for this module)');

        let params = {};
        if (paramsRaw) {
            try { params = JSON.parse(paramsRaw); }
            catch { return alert('Params JSON is invalid'); }
        }

        const res = await apiFetch(`/api/cases/${CASE_ID}/jobs`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ module, evidence_id: evidenceId || null, params })
        });
        if (res.ok) { loadJobs(); switchTab('jobs'); } // Auto switch to jobs to see progress
        else alert('Run failed');
    }

    document.getElementById('moduleSelect')?.addEventListener('change', () => {
        const module = document.getElementById('moduleSelect').value;
        const evSel = document.getElementById('targetEvidenceId');
        if (!evSel) return;
        evSel.disabled = !MODULE_REQUIRES_EVIDENCE.has(module);
    });

    // --- ARTIFACTS ---
    function setArtifactsPath(p) {
        CURRENT_ARTIFACTS_PATH = p || "";
        const badge = document.getElementById('artifactsPath');
        if (badge) badge.textContent = CURRENT_ARTIFACTS_PATH ? `/${CURRENT_ARTIFACTS_PATH}` : '/';
    }

    async function loadArtifacts(path = CURRENT_ARTIFACTS_PATH) {
        setArtifactsPath(path);
        const tree = document.getElementById('artifactTree');
        if (!tree) return;
        tree.textContent = 'Loading…';
        const qs = path ? `?path=${encodeURIComponent(path)}` : '';
        const res = await apiFetch(`/api/cases/${CASE_ID}/artifacts/tree${qs}`);
        if (!res.ok) { tree.textContent = `Failed to load (${res.status})`; return; }
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) { tree.innerHTML = '<div class="text-muted text-sm">Empty folder.</div>'; return; }

        tree.innerHTML = '';
        for (const it of items) {
            const row = document.createElement('div');
            row.className = 'artifact-item';

            const icon = document.createElement('span');
            icon.className = 'artifact-icon text-mono';
            icon.textContent = (it.type === 'dir') ? '[DIR]' : '[FILE]';

            const name = document.createElement('span');
            name.textContent = ` ${it.name}`;

            row.appendChild(icon);
            row.appendChild(name);

            row.addEventListener('click', () => {
                if (it.type === 'dir') openArtifactDir(it.path);
                else openArtifactFile(it.path);
            });

            tree.appendChild(row);
        }
    }

    function openArtifactDir(p) {
        loadArtifacts(p);
    }

    async function openArtifactFile(p) {
        const pre = document.getElementById('artifactPreview');
        if (!pre) return;
        pre.textContent = 'Loading…';
        const res = await apiFetch(`/api/cases/${CASE_ID}/artifacts/file?path=${encodeURIComponent(p)}`);
        if (!res.ok) { pre.textContent = `Failed to preview (${res.status})`; return; }
        const data = await res.json();
        if (data.kind === 'json' || data.kind === 'jsonl') {
            pre.textContent = JSON.stringify(data.data, null, 2);
        } else if (data.kind === 'csv') {
            pre.textContent = (data.rows || []).map(r => r.join(',')).join('\n');
        } else if (data.kind === 'binary' || data.kind === 'too_large') {
            pre.innerHTML = `<div class="text-muted">Preview unavailable (${escapeHtml(data.kind)}).</div><div class="mt-1"><a href="${escapeHtml(data.download_url)}" target="_blank">Download</a></div>`;
        } else {
            pre.textContent = data.text || '';
        }
    }

    function artifactsUp() {
        if (!CURRENT_ARTIFACTS_PATH) return loadArtifacts('');
        const parts = CURRENT_ARTIFACTS_PATH.split('/').filter(Boolean);
        parts.pop();
        loadArtifacts(parts.join('/'));
    }

    function copyText(s) {
        try {
            navigator.clipboard.writeText(s);
        } catch {
            // fallback
            const ta = document.createElement('textarea');
            ta.value = s;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }
    }

    // --- IOCS ---
    async function loadIOCs() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/iocs/`);
        const tbody = document.getElementById('iocList');
        if (!res.ok) return;
        const iocs = await res.json();

        if (iocs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No IOCs.</td></tr>';
            return;
        }
        tbody.innerHTML = iocs.map(i => `
            <tr>
                <td><span class="badge badge-info">${i.type}</span></td>
                <td class="text-mono text-sm">${i.value}</td>
                <td class="text-sm">${i.confidence}</td>
                <td class="text-sm text-muted">${new Date(i.created_at).toLocaleDateString()}</td>
            </tr>
        `).join('');
    }

    async function loadMatches() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/iocs/matches`);
        const div = document.getElementById('findingsList');
        if (!res.ok) return;
        const matches = await res.json();

        if (matches.length === 0) {
            div.innerHTML = '<div class="text-muted text-center p-4">No system findings yet.</div>';
            return;
        }

        div.innerHTML = matches.map(m => `
            <div class="card" style="margin-bottom:0.5rem; padding:1rem; border-left:4px solid var(--danger);">
                <div class="flex between">
                    <strong>Match: ${m.ioc_value}</strong>
                    <span class="badge badge-danger">IOC HIT</span>
                </div>
                <div class="text-sm mt-1">Found in: <span class="text-mono">${m.evidence_id || '?'}</span></div>
                 <div class="text-xs text-muted mt-1">${new Date(m.created_at).toLocaleString()}</div>
            </div>
        `).join('');
    }

    async function addIOC() {
        const type = document.getElementById('iocType').value;
        const value = document.getElementById('iocValue').value;
        if (!value) return;
        await apiFetch(`/api/cases/${CASE_ID}/iocs/`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, value, confidence: 'high' })
        });
        document.getElementById('iocValue').value = '';
        loadIOCs();
    }

    // Init
    loadData();
    // Poll Jobs
    setInterval(() => {
        if (document.getElementById('jobs').classList.contains('active')) loadJobs();
    }, 5000);

</script>
{% endblock %}
